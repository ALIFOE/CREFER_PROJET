#!/bin/bash
# 🧪 Script d'Installation et de Test - Dashboards CREFER

echo "=========================================="
echo "  CREFER Dashboard - Setup & Test"
echo "=========================================="
echo ""

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonctions
print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

print_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# 1. Vérifier Laravel
echo ""
print_info "Vérification de l'installation Laravel..."
if ! command -v php &> /dev/null; then
    print_error "PHP n'est pas installé"
    exit 1
fi
print_success "PHP trouvé"

# 2. Vérifier les fichiers
echo ""
print_info "Vérification des fichiers..."
files=(
    "resources/views/dashboards/enseignant.blade.php"
    "resources/views/dashboards/admin.blade.php"
    "resources/views/layouts/app.blade.php"
    "app/Http/Controllers/Client/DashboardController.php"
    "app/Http/Controllers/Admin/DashboardController.php"
)

all_files_exist=true
for file in "${files[@]}"; do
    if [ -f "$file" ]; then
        print_success "$file existe"
    else
        print_error "$file manquant"
        all_files_exist=false
    fi
done

if [ "$all_files_exist" = false ]; then
    print_error "Certains fichiers sont manquants"
    exit 1
fi

# 3. Vérifier la syntaxe PHP
echo ""
print_info "Vérification de la syntaxe PHP..."
php_files=(
    "app/Http/Controllers/Client/DashboardController.php"
    "app/Http/Controllers/Admin/DashboardController.php"
)

for file in "${php_files[@]}"; do
    if php -l "$file" > /dev/null 2>&1; then
        print_success "$file - Syntaxe OK"
    else
        print_error "$file - Erreur de syntaxe"
    fi
done

# 4. Créer les utilisateurs test (optionnel)
echo ""
print_info "Créer les utilisateurs test?"
echo "Appuyez sur Entrée pour continuer ou 'n' pour passer..."
read -r create_users

if [ "$create_users" != "n" ]; then
    print_info "Création des utilisateurs test..."
    
    # Enseignant
    php artisan tinker << EOF
\$user = \App\Models\User::firstOrCreate(
    ['email' => 'enseignant@test.com'],
    [
        'name' => 'Enseignant Test',
        'password' => Hash::make('password'),
        'role' => 'enseignant'
    ]
);
echo "Enseignant: \$user->email\n";
EOF
    
    # Admin
    php artisan tinker << EOF
\$admin = \App\Models\User::firstOrCreate(
    ['email' => 'admin@test.com'],
    [
        'name' => 'Admin Test',
        'password' => Hash::make('password'),
        'role' => 'admin'
    ]
);
echo "Admin: \$admin->email\n";
EOF
    
    print_success "Utilisateurs test créés"
fi

# 5. Lancer les tests
echo ""
print_info "Tests finaux..."
print_success "Installation complétée"

# 6. Afficher les informations
echo ""
echo "=========================================="
echo "  INFORMATION DE CONNEXION TEST"
echo "=========================================="
echo ""
print_info "Enseignant:"
echo "  Email: enseignant@test.com"
echo "  Password: password"
echo "  URL: http://localhost:8000/"
echo "  Sélectionnez: Onglet 'Enseignant'"
echo ""
print_info "Admin:"
echo "  Email: admin@test.com"
echo "  Password: password"
echo "  URL: http://localhost:8000/"
echo "  Sélectionnez: Onglet 'Admin'"
echo ""

# 7. Afficher les fichiers créés
echo "=========================================="
echo "  FICHIERS MODIFIÉS/CRÉÉS"
echo "=========================================="
echo ""
echo "✨ NOUVELLES VUES:"
echo "  • resources/views/dashboards/enseignant.blade.php"
echo "  • resources/views/dashboards/admin.blade.php"
echo ""
echo "🔧 CONTRÔLEURS MODIFIÉS:"
echo "  • app/Http/Controllers/Client/DashboardController.php"
echo "  • app/Http/Controllers/Admin/DashboardController.php"
echo ""
echo "📝 LAYOUTS MODIFIÉS:"
echo "  • resources/views/layouts/app.blade.php"
echo ""
echo "📚 DOCUMENTATION:"
echo "  • DASHBOARD_UPDATES.md"
echo "  • VISUAL_COMPARISON.md"
echo "  • TESTING_GUIDE.md"
echo "  • README_SUMMARY.md"
echo "  • INSTALLATION.sh (ce fichier)"
echo ""

# 8. Afficher les commandes utiles
echo "=========================================="
echo "  COMMANDES UTILES"
echo "=========================================="
echo ""
echo "# Lancer le serveur de développement"
echo "php artisan serve"
echo ""
echo "# Accéder à la page de connexion"
echo "http://localhost:8000"
echo ""
echo "# Vérifier les logs"
echo "tail -f storage/logs/laravel.log"
echo ""
echo "# Nettoyer le cache"
echo "php artisan cache:clear"
echo "php artisan view:clear"
echo ""

# 9. Recommandations
echo "=========================================="
echo "  PROCHAINES ÉTAPES"
echo "=========================================="
echo ""
print_info "1. Lancer le serveur: php artisan serve"
print_info "2. Aller à: http://localhost:8000"
print_info "3. Tester les deux rôles (Enseignant & Admin)"
print_info "4. Vérifier que:"
echo "   - Pas de barre de navigation"
echo "   - Footer minimaliste"
echo "   - Dashboards différents par rôle"
echo "   - Responsive design OK"
print_info "5. Consulter: TESTING_GUIDE.md pour tests détaillés"
echo ""

print_success "Configuration terminée! 🚀"
echo ""
